name: Playwright Regression Tests with Allure

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '30 3 * * 1-5'
  workflow_dispatch:

jobs:
  test:
    name: Run Tests & Generate Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'
          
      - name: Install Maven Dependencies
        run: mvn clean install -DskipTests
          
      - name: Install Playwright Browsers
        run: mvn exec:java -e -D exec.mainClass=com.microsoft.playwright.CLI -D exec.args="install chromium"
      
      - name: Get Allure History
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
          
      - name: Run Playwright Tests
        run: mvn clean test
        continue-on-error: true
        
      - name: Copy Allure History
        if: always()
        continue-on-error: true
        run: |
          mkdir -p target/allure-results/history
          if [ -d "gh-pages/history" ]; then
            cp -r gh-pages/history/* target/allure-results/history/
            echo "History copied successfully"
          else
            echo "No previous history found - this is normal for first run"
          fi
        
      - name: Generate Allure Report
        if: always()
        run: |
          mvn allure:report
          echo "Allure report generated at: target/allure-report"
          
      - name: Add Report Metadata
        if: always()
        run: |
          cd target/allure-report
          cat > environment.properties << EOF
          Browser=Chromium
          Framework=Playwright + TestNG
          Java.Version=11
          OS=${{ runner.os }}
          Execution.Date=$(date '+%Y-%m-%d %H:%M:%S')
          Build.Number=${{ github.run_number }}
          Branch=${{ github.ref_name }}
          Commit=${{ github.sha }}
          EOF
          
      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./target/allure-report
          keep_files: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy Allure Report - Run #${{ github.run_number }}'
          
      - name: Add Report URL to Summary
        if: always()
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          REPORT_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}"
          
          echo "## Test Execution Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Live Report" >> $GITHUB_STEP_SUMMARY
          echo "**[Click here to view the Allure Report](${REPORT_URL})**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Tip:** Bookmark the report URL for easy access!" >> $GITHUB_STEP_SUMMARY
          
      - name: Upload Allure Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: target/allure-report/
          retention-days: 30
          
      - name: Upload TestNG Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testng-reports
          path: test-output/
          retention-days: 30
          
      - name: Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-screenshots
          path: test-screenshots/
          retention-days: 7
          
      - name: Upload Traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: test-traces/
          retention-days: 7